@model IEnumerable<CMCS.Web.Models.Claim>
@using CMCS.Web.Services
@{
	ViewData["Title"] = "Academic Manager - Approve Claims";
	var validationResults = ViewBag.ValidationResults as Dictionary<int, ClaimValidationResult>;
}

<div class="row">
	<div class="col-12">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<div>
				<h1 class="mb-1">Academic Manager</h1>
				<p class="text-muted mb-0">Review and approve verified claims for payment processing</p>
			</div>
			<div class="text-end">
				<span class="badge bg-info fs-6">@Model.Count() Verified Claims</span>
			</div>
		</div>

		@if (TempData["SuccessMessage"] != null)
		{
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				<strong>Success!</strong> @TempData["SuccessMessage"]
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		}

		@if (TempData["ErrorMessage"] != null)
		{
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				<strong>Error!</strong> @TempData["ErrorMessage"]
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		}

		<div class="card border-0">
			<div class="card-header bg-white border-bottom">
				<h5 class="card-title mb-0">Claims Awaiting Approval</h5>
			</div>
			<div class="card-body p-0">
				@if (Model.Any())
				{
					<div class="table-responsive">
						<table class="table table-hover mb-0">
							<thead class="table-light">
								<tr>
									<th style="width: 7%;">Claim #</th>
									<th style="width: 13%;">Period</th>
									<th style="width: 10%;">Lecturer ID</th>
									<th style="width: 10%;" class="text-end">Hours</th>
									<th style="width: 10%;" class="text-end">Rate</th>
									<th style="width: 11%;" class="text-end">Amount</th>
									<th style="width: 8%;" class="text-center">Status</th>
									<th style="width: 15%;" class="text-center">Auto-Check</th>
									<th style="width: 16%;" class="text-center">Actions</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var claim in Model)
								{
									var monthName = new DateTime(claim.Year, claim.Month, 1).ToString("MMMM");
									var validation = validationResults?.GetValueOrDefault(claim.Id);
									var errorCount = validation?.ValidationIssues.Count(i => i.Severity == ValidationSeverity.Error) ?? 0;
									var warningCount = validation?.ValidationIssues.Count(i => i.Severity == ValidationSeverity.Warning) ?? 0;

									<tr>
										<td class="fw-bold text-info">#@claim.Id</td>
										<td>@monthName @claim.Year</td>
										<td>Lecturer @claim.LecturerId</td>
										<td class="text-end">@claim.TotalHours.ToString("N2") hrs</td>
										<td class="text-end">R @claim.HourlyRate.ToString("N2")</td>
										<td class="text-end fw-semibold text-success">R @claim.Amount.ToString("N2")</td>
										<td class="text-center">
											<span class="badge bg-info">@claim.Status</span>
										</td>
										<td class="text-center">
											@if (validation != null)
											{
												@if (errorCount > 0)
												{
													<span class="badge bg-danger" title="@errorCount error(s)">
														<i class="bi bi-x-circle"></i> @errorCount Error@(errorCount > 1 ? "s" : "")
													</span>
												}
												else if (warningCount > 0)
												{
													<span class="badge bg-warning text-dark" title="@warningCount warning(s)">
														<i class="bi bi-exclamation-triangle"></i> @warningCount Warning@(warningCount > 1 ? "s" : "")
													</span>
												}
												else
												{
													<span class="badge bg-success" title="All checks passed">
														<i class="bi bi-check-circle"></i> Passed
													</span>
												}
											}
											else
											{
												<span class="badge bg-secondary">N/A</span>
											}
										</td>
										<td class="text-center">
											<div class="btn-group btn-group-sm" role="group">
												<a asp-action="Review" asp-route-id="@claim.Id" class="btn btn-outline-primary" title="Review Details">
													Review
												</a>
												<button type="button" class="btn btn-outline-success approve-btn" data-claim-id="@claim.Id" title="Approve Claim">
													Approve
												</button>
												<button type="button" class="btn btn-outline-danger reject-btn" data-claim-id="@claim.Id" title="Reject Claim">
													Reject
												</button>
											</div>
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				}
				else
				{
					<div class="text-center py-5 text-muted">
						<div class="mb-3">
							<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-check2-all" viewBox="0 0 16 16">
								<path d="M12.354 4.354a.5.5 0 0 0-.708-.708L5 10.293 1.854 7.146a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0l7-7zm-4.208 7-.896-.897.707-.707.543.543 6.646-6.647a.5.5 0 0 1 .708.708l-7 7a.5.5 0 0 1-.708 0z"/>
								<path d="m5.354 7.146.896.897-.707.707-.897-.896a.5.5 0 1 1 .708-.708z"/>
							</svg>
						</div>
						<h5>All caught up!</h5>
						<p>There are no verified claims awaiting approval at the moment.</p>
					</div>
				}
			</div>
		</div>

		<div class="mt-4">
			<div class="card border-0 bg-light">
				<div class="card-body">
					<h6 class="fw-semibold mb-3">Approval Process</h6>
					<ul class="mb-0 small text-muted">
						<li>Review verified claims by clicking "Review" to see all details and coordinator verification notes</li>
						<li>Approve the claim for payment processing if everything is in order</li>
						<li>Reject the claim with a detailed comment if there are any concerns</li>
						<li>Approved claims will be forwarded to Finance for payment settlement</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form id="approveForm" asp-action="ApproveClaim" method="post">
				@Html.AntiForgeryToken()
				<input type="hidden" id="approveClaimId" name="id" />
				<div class="modal-header">
					<h5 class="modal-title" id="approveModalLabel">Approve Claim</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to approve claim <strong>#<span id="approveClaimNumber"></span></strong> for payment?</p>
					<div class="mb-3">
						<label for="approveComment" class="form-label">Comment (Optional)</label>
						<textarea class="form-control" id="approveComment" name="comment" rows="3" placeholder="Add any notes or comments..."></textarea>
					</div>
					<div class="alert alert-info small mb-0">
						<strong>Note:</strong> Approved claims will be sent to Finance for payment processing.
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-success">Approve for Payment</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form id="rejectForm" asp-action="RejectClaim" method="post">
				@Html.AntiForgeryToken()
				<input type="hidden" id="rejectClaimId" name="id" />
				<input type="hidden" name="returnTo" value="Manager" />
				<div class="modal-header">
					<h5 class="modal-title" id="rejectModalLabel">Reject Claim</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to reject claim <strong>#<span id="rejectClaimNumber"></span></strong>?</p>
					<div class="mb-3">
						<label for="rejectComment" class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
						<textarea class="form-control" id="rejectComment" name="comment" rows="3" placeholder="Please provide a detailed reason for rejecting this claim..." required></textarea>
						<div class="form-text">A comment is required when rejecting a claim.</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-danger">Reject Claim</button>
				</div>
			</form>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		$(document).ready(function() {
			// Approve button click
			$('.approve-btn').click(function() {
				const claimId = $(this).data('claim-id');
				$('#approveClaimId').val(claimId);
				$('#approveClaimNumber').text(claimId);
				$('#approveModal').modal('show');
			});

			// Reject button click
			$('.reject-btn').click(function() {
				const claimId = $(this).data('claim-id');
				$('#rejectClaimId').val(claimId);
				$('#rejectClaimNumber').text(claimId);
				$('#rejectModal').modal('show');
			});
		});
	</script>
}


 
